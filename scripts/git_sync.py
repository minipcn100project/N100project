# scripts/git_sync.py
"""
GitHub ìë™ ë™ê¸°í™”
"""
import subprocess
import os
from datetime import datetime
from pathlib import Path

def sync_to_github(nft_data):
    """
    NFT ë°ì´í„°ë¥¼ GitHubì— ìë™ ì»¤ë°‹ ë° í‘¸ì‹œ

    Args:
        nft_data: {
            "index": 1,
            "title": "ì œëª©",
            "image_path": "output/images/nft_001.png",
            "landing_url": "...",
            ...
        }
    """
    try:
        print("ğŸ“¦ Syncing to GitHub...")

        # ì´ë¯¸ì§€ íŒŒì¼ì„ public/imagesë¡œ ë³µì‚¬
        import shutil
        image_filename = Path(nft_data["image_path"]).name
        dest_path = Path(f"public/images/{image_filename}")
        dest_path.parent.mkdir(parents=True, exist_ok=True)
        shutil.copy(nft_data["image_path"], dest_path)

        # Git ëª…ë ¹ì–´ ì‹¤í–‰
        commands = [
            "git add public/",
            "git add output/metadata/",
            f'git commit -m "ğŸ¨ New NFT #{nft_data["index"]:03d}: {nft_data["title"]}\n\nğŸ¤– Auto-generated by N100 Mini PC\nğŸ’ Style: {nft_data["style"]}\nâ° {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}"',
            "git push origin main"
        ]

        for cmd in commands:
            result = subprocess.run(
                cmd,
                shell=True,
                capture_output=True,
                text=True
            )

            if result.returncode != 0:
                # commitì— ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ë•ŒëŠ” ì—ëŸ¬ê°€ ì•„ë‹˜
                if "nothing to commit" in result.stdout or "nothing to commit" in result.stderr:
                    print("â„¹ï¸  No changes to commit")
                    continue
                else:
                    print(f"âš ï¸  Git command warning: {result.stderr}")

        print("âœ… Synced to GitHub")

    except Exception as e:
        print(f"âŒ GitHub sync failed: {str(e)}")


def setup_git_repo():
    """
    Git ì €ì¥ì†Œ ì´ˆê¸° ì„¤ì • (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
    """
    commands = [
        "git init",
        "git branch -M main",
        f'git remote add origin https://github.com/{os.getenv("GITHUB_REPO")}.git'
    ]

    for cmd in commands:
        subprocess.run(cmd, shell=True)

    print("âœ… Git repository initialized")


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    test_data = {
        "index": 999,
        "title": "Test NFT",
        "image_path": "output/images/nft_999.png",
        "style": "realistic"
    }
    # sync_to_github(test_data)
    print("Git sync ready!")
